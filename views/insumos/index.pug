extends ../layout

block content
  - var page = 'insumos'
 
  .row.mb-4
    .col-12
      .d-flex.justify-content-between.align-items-center
        h1.display-6
          i.fas.fa-boxes.text-success.me-3
          | GestiÃ³n de Insumos
        a.btn.btn-success(href="/insumos/nuevo")
          i.fas.fa-plus.me-2
          | Nuevo Insumo

  if insumos && insumos.length > 0
    .row
      .col-12
        .card
          .card-header.bg-dark.text-white
            h5.mb-0
              i.fas.fa-boxes.me-2
              | Lista de Insumos (#{insumos.length})
          .card-body.p-0
            .table-responsive
              table.table.table-hover.mb-0
                thead.table-light
                  tr
                    th ID
                    th Nombre
                    th CategorÃ­a
                    th Stock
                    th Stock MÃ­nimo
                    th Unidad
                    // --- ðŸ‘‡ NUEVA COLUMNA ---
                    th Estado 
                    th Acciones
                tbody
                  each insumo in insumos
                    - const insumoId = insumo && insumo._id ? insumo._id.toString() : ''
                    tr
                      td= insumoId
                      td= insumo.nombre
                      td
                        span.badge(class= insumo.categoria === 'alimentos' ? 'bg-success' : insumo.categoria === 'bebidas' ? 'bg-info' : insumo.categoria === 'limpieza' ? 'bg-warning' : insumo.categoria === 'utensilios' ? 'bg-primary' : 'bg-secondary')= insumo.categoria
                      td= insumo.stock
                      td= insumo.stockMinimo
                      td= insumo.unidadMedida || 'N/A'
                      
                      // --- ðŸ‘‡ NUEVA CELDA CON BADGE DE ESTADO ---
                      td
                        - var estadoClass = insumo.estado === 'disponible' ? 'bg-success' : insumo.estado === 'bajo_stock' ? 'bg-warning' : 'bg-danger'
                        - var estadoTexto = insumo.estado.replace('_', ' ') // Reemplaza guion bajo por espacio
                        span.badge(class=estadoClass, style="text-transform: capitalize;")= estadoTexto
                      
                      td
                        .btn-group(role="group")
                          a.btn.btn-sm.btn-outline-primary(href=`/api/insumos/${insumoId}`, target="_blank", title="Ver")
                            i.fas.fa-eye
                          a.btn.btn-sm.btn-outline-warning(href=`/insumos/editar/${insumoId}`, title="Editar")
                            i.fas.fa-edit
                          button.btn.btn-sm.btn-outline-danger(data-id=insumoId, onclick="eliminarInsumo(this)", title="Eliminar")
                            i.fas.fa-trash
    // Script de eliminar (sin cambios)
    script.
      async function eliminarInsumo(button) {
        if (confirm('Â¿EstÃ¡s seguro de eliminar este insumo?')) {
          const id = button.getAttribute('data-id');
          try {
            const response = await fetch(`/api/insumos/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
              alert('Insumo eliminado exitosamente');
              location.reload();
            } else {
              alert(`Error: ${result.message}`);
            }
          } catch (error) {
            console.error('Error al eliminar insumo:', error);
            alert('Error de conexiÃ³n al eliminar el insumo');
          }
        }
      }
  else
    .row
      .col-12
        .card
          .card-body.text-center.py-5
            i.fas.fa-boxes.text-muted.mb-3(style="font-size: 4rem;")
            h4.text-muted No hay insumos registrados
            p.text-muted Registra el primer insumo para comenzar
            a.btn.btn-success(href="/insumos/nuevo")
              i.fas.fa-plus.me-2
              | Registrar Primer Insumo